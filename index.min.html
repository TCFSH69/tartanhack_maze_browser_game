<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><style>body{margin:0;overflow:hidden;background:#000;color:#fff;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;touch-action:none}canvas{display:block;image-rendering:pixelated}#ui{position:absolute;top:10px;left:10px;z-index:10;pointer-events:none;text-shadow:1px 1px 2px #000;font-weight:700}#effects-ui{margin-top:6px;opacity:.9;font-size:12px;font-weight:700}#objective-ui{margin-top:6px;font-size:12px;font-weight:800;letter-spacing:.2px;opacity:.95}.chk{opacity:.85}.ok{color:rgba(0,255,0,.95);text-shadow:0 0 12px rgba(0,255,0,.2)}.no{color:rgba(255,255,255,.85)}#toast{position:absolute;top:18px;left:50%;transform:translateX(-50%);z-index:40;background:rgba(0,0,0,.72);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);padding:10px 14px;border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.55),0 0 18px rgba(255,200,0,.18);font-weight:900;font-size:13px;letter-spacing:.2px;opacity:0;pointer-events:none;transition:opacity 180ms ease,transform 180ms ease}#toast.show{opacity:1;transform:translateX(-50%) translateY(6px)}#toast .sub{display:block;font-weight:800;opacity:.85;font-size:12px;margin-top:3px}#start-btn{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);padding:20px 40px;font-size:24px;font-weight:900;background:#0f0;color:#000;border:3px solid #fff;cursor:pointer;border-radius:14px;box-shadow:0 0 18px rgba(0,255,0,.85),0 12px 30px rgba(0,0,0,.65);z-index:20}#controls-hint{position:absolute;bottom:10px;width:100%;text-align:center;color:#888;font-size:12px;pointer-events:none}#flash-btn{position:absolute;top:10px;right:10px;z-index:20;padding:10px 18px;font-size:14px;font-weight:700;background:#fff;color:#000;border:2px solid gold;cursor:pointer;border-radius:10px;box-shadow:0 0 10px rgba(255,255,255,.5)}#flash-btn:disabled{opacity:.3;cursor:default}#flash-overlay{display:none;position:absolute;top:0;left:0;width:100%;height:100%;z-index:25;align-items:center;justify-content:center;flex-direction:column;background:#fff;opacity:1;transition:opacity 2s ease,background 1.2s ease}#flash-overlay.fade-out{opacity:0}#flash-overlay img{max-width:70%;max-height:50%;object-fit:contain;opacity:0;transition:opacity 1.2s ease;filter:drop-shadow(0 0 40px rgba(255,255,255,.8))}#flash-overlay.show-ad{background:rgba(0,0,0,.9)}#flash-overlay.show-ad img{opacity:1}.end-screen{display:none;position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.9);z-index:30;align-items:center;justify-content:center;text-align:center;flex-direction:column}.end-screen h1{font-size:60px;margin:0;letter-spacing:5px}.end-screen p{font-size:20px;margin:5px 0}#win h1{color:gold;text-shadow:0 0 20px gold}#lose h1{color:red;text-shadow:0 0 20px red}.start-panel{position:absolute;top:50%;left:50%;width:340px;padding:16px 18px;border-radius:18px;background:rgba(10,14,18,.78);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);color:rgba(255,255,255,.92);box-shadow:0 0 18px rgba(0,255,0,.18),0 10px 30px rgba(0,0,0,.55);pointer-events:none;user-select:none;z-index:19;opacity:0;transform-origin:center;animation:panelIn .7s ease forwards}@keyframes panelIn{from{opacity:0;filter:blur(2px)}to{opacity:1;filter:blur(0)}}.start-panel h3{margin:0 0 8px 0;font-size:14px;letter-spacing:1px;text-transform:uppercase;color:rgba(0,255,0,.95);text-shadow:0 0 10px rgba(0,255,0,.25);display:flex;align-items:center;gap:8px}.start-panel ul{margin:0;padding-left:18px;line-height:1.55;font-size:13px;color:rgba(255,255,255,.9)}.start-panel li{margin:6px 0}.kbd{display:inline-block;padding:2px 7px;margin:0 2px;border-radius:9px;background:rgba(255,255,255,.12);box-shadow:inset 0 0 0 1px rgba(255,255,255,.14);font-weight:800;font-size:12px;letter-spacing:.5px}.pulse-hint{position:absolute;top:50%;left:50%;transform:translate(-50%,calc(-50% + 95px));z-index:19;pointer-events:none;user-select:none;font-size:13px;color:rgba(255,255,255,.75);text-shadow:0 0 12px rgba(0,0,0,.8);animation:pulse 1.2s ease-in-out infinite}@keyframes pulse{0%,100%{opacity:.55}50%{opacity:1}}#panel-top{transform:translate(-50%,calc(-50% - 230px))}#panel-left{transform:translate(calc(-50% - 450px),-50%)}#panel-right{transform:translate(calc(-50% + 450px),-50%)}#panel-bottom{transform:translate(-50%,calc(-50% + 210px));width:520px}@media (max-width:980px){.start-panel{width:300px}#panel-top{transform:translate(-50%,calc(-50% - 240px))}#panel-left{transform:translate(-50%,calc(-50% + 200px))}#panel-right{transform:translate(-50%,calc(-50% + 355px))}#panel-bottom{transform:translate(-50%,calc(-50% + 510px));width:300px}.pulse-hint{transform:translate(-50%,calc(-50% + 110px))}}</style></head><body><div id="toast">‚ö†Ô∏è You can't escape yet! <span class="sub">Find at least one üåÄ and one üîÄ first.</span></div><div id="ui">Mic Level: <span id="mic-val">0</span><br>Ghosts: <span id="ghost-count">5</span><div id="effects-ui"></div><div id="objective-ui"></div></div><div id="panel-top" class="start-panel"><h3>üéØ Objective</h3><ul><li>Collect at least <b>one</b> üåÄ <b>and</b> <b>one</b> üîÄ.</li><li>Then touch the <span class="kbd">üèÅ</span> flag to <b>escape</b>.</li><li>Avoid ghosts üëª ‚Äî touching one = üíÄ</li></ul></div><div id="panel-left" class="start-panel"><h3>üïπÔ∏è Movement</h3><ul><li>Keyboard: <span class="kbd">W</span><span class="kbd">A</span><span class="kbd">S</span><span class="kbd">D</span></li><li>Mobile: left joystick to move üëà</li></ul></div><div id="panel-right" class="start-panel"><h3>üéÆ Aim & Shoot</h3><ul><li>Mouse: aim direction üñ±Ô∏è</li><li>Mobile: right joystick to aim üëâ</li><li><b>Scream</b> to shoot üé§ (mic loudness)</li></ul></div><div id="panel-bottom" class="start-panel"><h3>üí• Tools & Powerups</h3><ul><li><span class="kbd">Flash Grenade</span> (one-time): reveals the whole map briefly ‚ú®</li><li>üîÄ <b>Invert</b> (10s): movement flips (W‚ÜîS, A‚ÜîD). Shooting unaffected.</li><li>üåÄ <b>Wobble</b> (10s): camera shakes/wobbles.</li><li>üõ°Ô∏è <b>Invincible</b> (5s): ghosts can‚Äôt kill you.</li></ul></div><div id="start-hint" class="pulse-hint">‚ú® Click <b>START ESCAPE</b> to begin</div><button id="start-btn">START ESCAPE</button><div id="controls-hint">WASD to Move | Mouse to Aim | Scream to Shoot</div><button id="flash-btn">Flash Grenade</button><canvas id="gameCanvas"></canvas><div id="flash-overlay"><img src="27e3d95f-7921-4231-9fad-420a3afd34d2_1251x779.webp" alt="AppLovin"></div><div id="win" class="end-screen"><div><h1>ESCAPED</h1><p>You found the goal.</p><p style="opacity:.7;margin-top:15px;font-size:14px">(Click anywhere to restart)</p></div></div><div id="lose" class="end-screen"><div><h1>YOU DIED</h1><p>You have been caught.</p><p style="opacity:.7;margin-top:15px;font-size:14px">(Click anywhere to restart)</p></div></div><script>const MAP_WIDTH=31,MAP_HEIGHT=31,TILE_SIZE=20,FLOOR_COLOR="#222",WALL_COLOR="#555",PLAYER_MOVE_DELAY=10,GHOST_COUNT=5,GHOST_SPEED=.25,GHOST_RESPAWN_TIME=300,BULLET_SPEED=4,FIRE_THRESHOLD=10,FIRE_COOLDOWN=400,PIXEL_SCALE=3,POWERUP_COUNTS={invert:2,wobble:2,invincible:1},POWERUP_TYPES={invert:{emoji:"üîÄ",durationMs:1e4},wobble:{emoji:"üåÄ",durationMs:1e4},invincible:{emoji:"üõ°Ô∏è",durationMs:5e3}},canvas=document.getElementById("gameCanvas"),ctx=canvas.getContext("2d"),uiMic=document.getElementById("mic-val"),uiGhostCount=document.getElementById("ghost-count"),effectsUI=document.getElementById("effects-ui"),objectiveUI=document.getElementById("objective-ui"),toast=document.getElementById("toast"),startBtn=document.getElementById("start-btn"),winScreen=document.getElementById("win"),loseScreen=document.getElementById("lose"),panelTop=document.getElementById("panel-top"),panelLeft=document.getElementById("panel-left"),panelRight=document.getElementById("panel-right"),panelBottom=document.getElementById("panel-bottom"),startHint=document.getElementById("start-hint");function setTutorialVisible(e){const t=e?"block":"none";panelTop.style.display=t,panelLeft.style.display=t,panelRight.style.display=t,panelBottom.style.display=t,startHint.style.display=t}setTutorialVisible(!0);const playerImg=new Image;playerImg.src="player.jpg";let playerImgReady=!1;playerImg.onload=()=>{playerImgReady=!0};const ghostImg=new Image;ghostImg.src="ghost.jpg";let ghostImgReady=!1;ghostImg.onload=()=>{ghostImgReady=!0};let fogCanvas,fogCtx,audioContext,analyser,dataArray,map=[],player={x:1,y:1,dirX:0,dirY:1,aimDirX:0,aimDirY:1,moveTimer:0},goal={x:0,y:0},bullets=[],lastFireTime=0,ghosts=[],flashActive=!1,flashUsed=!1,micLevel=0,gameActive=!1,activeKeys=[],leftTouchId=null,leftStick={startX:0,startY:0,currX:0,currY:0,active:!1},rightTouchId=null,rightStick={startX:0,startY:0,currX:0,currY:0,active:!1},mousePos={x:0,y:0},powerups=[],effects={invertUntil:0,wobbleUntil:0,invincibleUntil:0},objective={gotInvert:!1,gotWobble:!1},toastTimer=null;function showToast(e,t){toast.innerHTML=`${e}<span class="sub">${t}</span>`,toast.classList.add("show"),toastTimer&&clearTimeout(toastTimer),toastTimer=setTimeout(()=>toast.classList.remove("show"),1800)}function updateEffectsUI(){const e=Date.now(),t=[];e<effects.invertUntil&&t.push(`üîÄ Invert: ${Math.ceil((effects.invertUntil-e)/1e3)}s`),e<effects.wobbleUntil&&t.push(`üåÄ Wobble: ${Math.ceil((effects.wobbleUntil-e)/1e3)}s`),e<effects.invincibleUntil&&t.push(`üõ°Ô∏è Invincible: ${Math.ceil((effects.invincibleUntil-e)/1e3)}s`),effectsUI.innerText=t.length?t.join(" | "):""}function updateObjectiveUI(){const e=objective.gotInvert,t=objective.gotWobble;objectiveUI.innerHTML=`Objective: <span class="chk ${t?"ok":"no"}">üåÄ ${t?"OK":"0/1"}</span>  <span class="chk ${e?"ok":"no"}">üîÄ ${e?"OK":"0/1"}</span>  ‚Üí <span class="chk ${t&&e?"ok":"no"}">üèÅ Escape</span>`}function isWalkableCell(e,t){return e>=0&&e<31&&t>=0&&t<31&&1===map[t][e]}function cellOccupiedByPowerup(e,t){return powerups.some(a=>a.x===e&&a.y===t)}function spawnPowerups(){powerups=[];const e=[{x:player.x,y:player.y},{x:goal.x,y:goal.y}];function t(t,a){return e.some(e=>Math.abs(t-e.x)+Math.abs(a-e.y)<6)}function a(e,a){let n=0,i=0;for(;n<a&&i<5e3;){i++;const a=Math.floor(31*Math.random()),l=Math.floor(31*Math.random());isWalkableCell(a,l)&&(cellOccupiedByPowerup(a,l)||t(a,l)||(powerups.push({x:a,y:l,type:e,emoji:POWERUP_TYPES[e].emoji}),n++))}}a("invert",POWERUP_COUNTS.invert),a("wobble",POWERUP_COUNTS.wobble),a("invincible",POWERUP_COUNTS.invincible)}function activatePowerup(e){const t=Date.now(),a=POWERUP_TYPES[e].durationMs;"invert"===e&&(effects.invertUntil=Math.max(effects.invertUntil,t+a),objective.gotInvert=!0),"wobble"===e&&(effects.wobbleUntil=Math.max(effects.wobbleUntil,t+a),objective.gotWobble=!0),"invincible"===e&&(effects.invincibleUntil=Math.max(effects.invincibleUntil,t+a)),updateObjectiveUI()}function checkPowerupPickup(){for(let e=powerups.length-1;e>=0;e--){const t=powerups[e];t.x===player.x&&t.y===player.y&&(activatePowerup(t.type),powerups.splice(e,1))}}function canEscapeNow(){return objective.gotInvert&&objective.gotWobble}function generateMaze(){map=[];for(let e=0;e<31;e++){let e=[];for(let t=0;t<31;t++)e.push(0);map.push(e)}let e=[];for(map[1][1]=1,e.push({x:1,y:1});e.length>0;){let t=e[e.length-1],a=[],n=[{dx:0,dy:-2},{dx:0,dy:2},{dx:-2,dy:0},{dx:2,dy:0}];for(let e of n){let n=t.x+e.dx,i=t.y+e.dy;n>0&&n<30&&i>0&&i<30&&0===map[i][n]&&a.push({x:n,y:i,dx:e.dx,dy:e.dy})}if(a.length>0){let n=a[Math.floor(Math.random()*a.length)];map[t.y+n.dy/2][t.x+n.dx/2]=1,map[n.y][n.x]=1,e.push({x:n.x,y:n.y})}else e.pop()}for(let e=1;e<30;e++)for(let t=1;t<30;t++)if(0===map[e][t]&&Math.random()<.05){let a=0;1===map[e-1][t]&&a++,1===map[e+1][t]&&a++,1===map[e][t-1]&&a++,1===map[e][t+1]&&a++,a>=2&&(map[e][t]=1)}player.x=1,player.y=1,player.dirX=0,player.dirY=1,player.aimDirX=0,player.aimDirY=1,player.moveTimer=0,effects.invertUntil=0,effects.wobbleUntil=0,effects.invincibleUntil=0,objective.gotInvert=!1,objective.gotWobble=!1,updateObjectiveUI();let t=0;for(let e=0;e<31;e++)for(let a=0;a<31;a++)if(1===map[e][a]){let n=Math.abs(a-player.x)+Math.abs(e-player.y);n>t&&(t=n,goal={x:a,y:e})}ghosts=[];for(let e=0;e<5;e++){let e=!1;for(;!e;){let t=Math.floor(31*Math.random()),a=Math.floor(31*Math.random());1===map[a][t]&&Math.abs(t-player.x)+Math.abs(a-player.y)>10&&(ghosts.push(new Ghost(t,a)),e=!0)}}spawnPowerups(),uiGhostCount.innerText=ghosts.length,uiGhostCount.style.color="white",startBtn.style.display="none",setTutorialVisible(!1),winScreen.style.display="none",loseScreen.style.display="none",gameActive=!0}class Ghost{constructor(e,t){this.x=20*e,this.y=20*t,this.size=18,this.color="red",this.speed=.25,this.targetX=this.x,this.targetY=this.y,this.isDead=!1,this.respawnTimer=0}update(e,t){if(this.isDead)return this.respawnTimer--,void(this.respawnTimer<=0&&this.respawn(e,t));if(Math.abs(this.x-this.targetX)+Math.abs(this.y-this.targetY)<this.speed){this.x=this.targetX,this.y=this.targetY;let a=Math.round(this.x/20),n=Math.round(this.y/20),i=this.bfs(a,n,e.x,e.y,t);i&&(this.targetX=20*i.x,this.targetY=20*i.y)}this.x<this.targetX&&(this.x+=this.speed),this.x>this.targetX&&(this.x-=this.speed),this.y<this.targetY&&(this.y+=this.speed),this.y>this.targetY&&(this.y-=this.speed)}respawn(e,t){let a=100;for(;a-- >0;){let a=Math.floor(31*Math.random()),n=Math.floor(31*Math.random());if(1===t[n][a]&&Math.abs(a-e.x)+Math.abs(n-e.y)>15){this.x=20*a,this.y=20*n,this.targetX=this.x,this.targetY=this.y,this.isDead=!1;break}}}bfs(e,t,a,n,i){if(e===a&&t===n)return null;let l=[{x:e,y:t}],o={},r=`${e},${t}`;o[r]=null;let s=!1,c=0;for(;l.length>0&&c<500;){c++;let e=l.shift();if(e.x===a&&e.y===n){s=!0;break}for(let[t,a]of[[0,-1],[0,1],[-1,0],[1,0]]){let n=e.x+t,r=e.y+a,s=`${n},${r}`;n>=0&&n<31&&r>=0&&r<31&&1===i[r][n]&&!o.hasOwnProperty(s)&&(l.push({x:n,y:r}),o[s]={x:e.x,y:e.y})}}if(!s)return null;let u=`${a},${n}`,h=[];if(!o[u])return null;for(;u!==r;){let e=u.split(",").map(Number);h.push({x:e[0],y:e[1]});let t=o[u];u=`${t.x},${t.y}`}return h[h.length-1]}checkCollision(e){if(this.isDead)return!1;let t=20*e.x,a=20*e.y;return this.x<t+20-4&&this.x+this.size>t+4&&this.y<a+20-4&&this.y+this.size>a+4}draw(e,t,a){if(this.isDead)return;let n=this.x+t,i=this.y+a;if(ghostImgReady)return void e.drawImage(ghostImg,n,i,this.size,this.size);e.fillStyle=this.color,e.fillRect(n,i,this.size,this.size);let l=this.targetX>this.x?2:this.targetX<this.x?-2:0,o=this.targetY>this.y?2:this.targetY<this.y?-2:0;e.fillStyle="white",e.fillRect(n+4+l,i+4+o,5,5),e.fillRect(n+10+l,i+4+o,5,5)}}async function initAudio(){try{const e=await navigator.mediaDevices.getUserMedia({audio:!0});audioContext=new(window.AudioContext||window.webkitAudioContext),analyser=audioContext.createAnalyser(),audioContext.createMediaStreamSource(e).connect(analyser),analyser.fftSize=256,dataArray=new Uint8Array(analyser.frequencyBinCount),generateMaze(),playSong(),gameLoop()}catch(e){alert("Microphone denied! Please allow access.")}}function updateMic(){if(!analyser)return;analyser.getByteFrequencyData(dataArray);let e=0;for(let t=0;t<dataArray.length;t++)e+=dataArray[t];let t=e/dataArray.length;micLevel=Math.min(10,Math.floor(t/10)),uiMic.innerText=micLevel+` (dB: ${Math.floor(t)})`,gameActive&&t>10&&Date.now()-lastFireTime>400&&(fireBullet(),lastFireTime=Date.now())}function fireBullet(){bullets.push({x:20*player.x+10,y:20*player.y+10,vx:4*player.aimDirX,vy:4*player.aimDirY}),playShootSound()}function updateBullets(){for(let e=bullets.length-1;e>=0;e--){let t=bullets[e];t.x+=t.vx,t.y+=t.vy;let a=Math.floor(t.x/20),n=Math.floor(t.y/20);if(a<0||a>=31||n<0||n>=31||0===map[n][a])bullets.splice(e,1);else for(let a of ghosts)if(!a.isDead&&t.x>a.x&&t.x<a.x+a.size&&t.y>a.y&&t.y<a.y+a.size){a.isDead=!0,a.respawnTimer=300,bullets.splice(e,1);break}}}function updateAim(){if(rightStick.active){let e=rightStick.currX-rightStick.startX,t=rightStick.currY-rightStick.startY;(Math.abs(e)>10||Math.abs(t)>10)&&(Math.abs(e)>Math.abs(t)?(player.aimDirX=e>0?1:-1,player.aimDirY=0):(player.aimDirX=0,player.aimDirY=t>0?1:-1))}else{let e=window.innerWidth/2,t=window.innerHeight/2,a=mousePos.x-e,n=mousePos.y-t;0===a&&0===n||(Math.abs(a)>Math.abs(n)?(player.aimDirX=a>0?1:-1,player.aimDirY=0):(player.aimDirX=0,player.aimDirY=n>0?1:-1))}}function updatePlayerMovement(){if(player.moveTimer>0)return void player.moveTimer--;let e=0,t=0;if(leftStick.active){let a=leftStick.currX-leftStick.startX,n=leftStick.currY-leftStick.startY;(Math.abs(a)>20||Math.abs(n)>20)&&(Math.abs(a)>Math.abs(n)?e=a>0?1:-1:t=n>0?1:-1)}else if(activeKeys.length>0){const a=activeKeys[activeKeys.length-1];"w"===a||"ArrowUp"===a?t=-1:"s"===a||"ArrowDown"===a?t=1:"a"===a||"ArrowLeft"===a?e=-1:"d"!==a&&"ArrowRight"!==a||(e=1)}if(Date.now()<effects.invertUntil&&(e*=-1,t*=-1),0!==e||0!==t){player.dirX=e,player.dirY=t;let a=player.x+e,n=player.y+t;if(a>=0&&a<31&&n>=0&&n<31&&1===map[n][a]){player.x=a,player.y=n,player.moveTimer=10,checkPowerupPickup();let e=0;if(0===map[player.y-1]?.[player.x]&&e++,0===map[player.y+1]?.[player.x]&&e++,0===map[player.y]?.[player.x-1]&&e++,0===map[player.y]?.[player.x+1]&&e++,e>=3&&playGobackSound(),player.x===goal.x&&player.y===goal.y)if(canEscapeNow())gameOver("win");else{const e=objective.gotWobble?"":"üåÄ",t=objective.gotInvert?"":"üîÄ";showToast("‚ö†Ô∏è You can‚Äôt escape yet!",`Find ${e}${e&&t?" and ":""}${t} first.`)}}}}function draw(){canvas.style.width=window.innerWidth+"px",canvas.style.height=window.innerHeight+"px",canvas.width=Math.max(1,Math.floor(window.innerWidth/3)),canvas.height=Math.max(1,Math.floor(window.innerHeight/3)),ctx.imageSmoothingEnabled=!1;const e=Date.now();let t,a,n,i,l,o,r=1;if(flashActive){let e=620,t=620;r=.9*Math.min(canvas.width/e,canvas.height/t)}if(flashActive)t=canvas.width/2-620*r/2,a=canvas.height/2-620*r/2,ctx.save(),ctx.translate(t,a),ctx.scale(r,r),t=0,a=0;else if(t=canvas.width/2-20*player.x-10,a=canvas.height/2-20*player.y-10,e<effects.wobbleUntil){const n=.015*e;t+=8*Math.sin(n),a+=8*Math.cos(1.3*n)}if(ctx.fillStyle="#000",ctx.fillRect(0,0,canvas.width,canvas.height),flashActive)n=0,i=0,l=30,o=30;else{let e=Math.ceil(canvas.width/20),r=Math.ceil(canvas.height/20);n=Math.floor(-t/20),i=Math.floor(-a/20),l=n+e,o=i+r}for(let e=i;e<=o;e++)for(let i=n;i<=l;i++)if(e>=0&&e<31&&i>=0&&i<31){let n=20*i+t,l=20*e+a;ctx.fillStyle=0===map[e][i]?"#555":"#222",ctx.fillRect(n,l,20,20)}ctx.save(),ctx.font=`${Math.max(8,Math.floor(18))}px Arial`,ctx.textAlign="center",ctx.textBaseline="middle";for(const e of powerups){const n=20*e.x+t+10,i=20*e.y+a+10;ctx.shadowColor="rgba(255,255,255,0.35)",ctx.shadowBlur=10,ctx.fillText(e.emoji,n,i)}ctx.restore(),ctx.fillStyle="#ffff00";for(let e of bullets)ctx.beginPath(),ctx.arc(e.x+t,e.y+a,4,0,2*Math.PI),ctx.fill();let s=20*player.x+t,c=20*player.y+a;e<effects.invincibleUntil&&(ctx.save(),ctx.strokeStyle="rgba(0,255,255,0.9)",ctx.lineWidth=3,ctx.shadowColor="rgba(0,255,255,0.8)",ctx.shadowBlur=18,ctx.strokeRect(s-3,c-3,26,26),ctx.restore()),playerImgReady?ctx.drawImage(playerImg,s,c,20,20):(ctx.fillStyle="#0f0",ctx.fillRect(s,c,20,20),ctx.fillStyle="#000",ctx.beginPath(),ctx.arc(s+10+6*player.dirX,c+10+6*player.dirY,2.2,0,2*Math.PI),ctx.fill());let u=c+10,h=s+10+40*player.aimDirX,f=u+40*player.aimDirY;ctx.save(),ctx.strokeStyle="#ff0000",ctx.lineWidth=3,ctx.shadowColor="#ff0000",ctx.shadowBlur=15,ctx.beginPath(),ctx.arc(h,f,10,0,2*Math.PI),ctx.moveTo(h-14,f),ctx.lineTo(h+14,f),ctx.moveTo(h,f-14),ctx.lineTo(h,f+14),ctx.stroke(),ctx.restore();let p=0;for(let e of ghosts)e.draw(ctx,t,a),e.isDead||p++;uiGhostCount.innerText=p;let d=20*goal.x+t,y=20*goal.y+a;ctx.fillStyle="gold",ctx.font="16px Arial",ctx.fillText("üö©",d,y+16);let m=s+10,g=c+10;if(flashActive&&ctx.restore(),!flashActive){fogCanvas||(fogCanvas=document.createElement("canvas"),fogCtx=fogCanvas.getContext("2d")),fogCanvas.width=canvas.width,fogCanvas.height=canvas.height,fogCtx.globalCompositeOperation="source-over",fogCtx.fillStyle="#000",fogCtx.fillRect(0,0,fogCanvas.width,fogCanvas.height),fogCtx.globalCompositeOperation="destination-out";let e=100,n=fogCtx.createRadialGradient(m,g,0,m,g,e);n.addColorStop(0,"rgba(0,0,0,1)"),n.addColorStop(.6,"rgba(0,0,0,0.5)"),n.addColorStop(1,"rgba(0,0,0,0)"),fogCtx.fillStyle=n,fogCtx.beginPath(),fogCtx.arc(m,g,e,0,2*Math.PI),fogCtx.fill();for(let e of bullets)fogCtx.beginPath(),fogCtx.arc(e.x+t,e.y+a,30,0,2*Math.PI),fogCtx.fillStyle="rgba(0,0,0,1)",fogCtx.fill();ctx.drawImage(fogCanvas,0,0)}drawJoystick(leftStick,"Move"),drawJoystick(rightStick,"Aim");let x=Math.atan2(goal.y-player.y,goal.x-player.x),v=m+80*Math.cos(x),T=g+80*Math.sin(x);ctx.save(),ctx.translate(v,T),ctx.rotate(x),ctx.beginPath(),ctx.moveTo(14,0),ctx.lineTo(-14,-8.4),ctx.lineTo(.4*-14,0),ctx.lineTo(-14,8.4),ctx.closePath(),ctx.fillStyle="rgb(255,255,255)",ctx.shadowColor="rgb(255,255,255)",ctx.shadowBlur=10,ctx.fill(),ctx.restore()}function drawJoystick(e,t){if(!e.active)return;let a=e.startX/3,n=e.startY/3,i=e.currX/3,l=e.currY/3;ctx.beginPath(),ctx.arc(a,n,40/3,0,2*Math.PI),ctx.fillStyle="rgba(255, 255, 255, 0.2)",ctx.fill(),ctx.strokeStyle="rgba(255, 255, 255, 0.4)",ctx.lineWidth=2,ctx.stroke(),ctx.beginPath(),ctx.arc(i,l,20/3,0,2*Math.PI),ctx.fillStyle="rgba(255, 255, 255, 0.5)",ctx.fill(),ctx.fillStyle="#fff",ctx.font=Math.floor(4)+"px sans-serif",ctx.textAlign="center",ctx.fillText(t,a,n+20)}function gameOver(e){gameActive=!1,"win"===e?winScreen.style.display="flex":(playDeathSound(),loseScreen.style.display="flex")}function restart(){location.reload()}function gameLoop(){if(updateMic(),updateEffectsUI(),updateObjectiveUI(),gameActive){updateAim(),updatePlayerMovement(),updateBullets();const e=Date.now()<effects.invincibleUntil;for(let t of ghosts)if(flashActive||t.update(player,map),!e&&t.checkCollision(player))return void gameOver("lose")}draw(),requestAnimationFrame(gameLoop)}function playGobackSound(){let e=new AudioContext,t=e.currentTime;for(let a=0;a<2;a++){let n=e.createOscillator(),i=e.createGain();n.type="square",n.frequency.setValueAtTime(200,t+.15*a),i.gain.setValueAtTime(.8,t+.15*a),i.gain.exponentialRampToValueAtTime(.01,t+.15*a+.1),n.connect(i),i.connect(e.destination),n.start(t+.15*a),n.stop(t+.15*a+.1)}}function playDeathSound(){let e=new AudioContext,t=e.currentTime,a=e.createOscillator(),n=e.createGain();a.type="sawtooth",a.frequency.setValueAtTime(500,t),a.frequency.exponentialRampToValueAtTime(40,t+.8),n.gain.setValueAtTime(1,t),n.gain.exponentialRampToValueAtTime(.01,t+.8),a.connect(n),n.connect(e.destination),a.start(),a.stop(t+.8);let i=e.createBuffer(1,.5*e.sampleRate,e.sampleRate),l=i.getChannelData(0);for(let e=0;e<l.length;e++)l[e]=2*Math.random()-1;let o=e.createBufferSource(),r=e.createGain();o.buffer=i,r.gain.setValueAtTime(.8,t),r.gain.exponentialRampToValueAtTime(.01,t+.5),o.connect(r),r.connect(e.destination),o.start()}function playFlashSound(){let e=new AudioContext,t=e.currentTime,a=e.createOscillator(),n=e.createGain();a.type="sine",a.frequency.setValueAtTime(2e3,t),a.frequency.exponentialRampToValueAtTime(500,t+1),n.gain.setValueAtTime(1,t),n.gain.exponentialRampToValueAtTime(.01,t+1),a.connect(n),n.connect(e.destination),a.start(),a.stop(t+1);let i=e.createOscillator(),l=e.createGain();i.type="triangle",i.frequency.setValueAtTime(150,t),l.gain.setValueAtTime(.7,t),l.gain.exponentialRampToValueAtTime(.01,t+1.2),i.connect(l),l.connect(e.destination),i.start(),i.stop(t+1.2);let o=e.createBuffer(1,.3*e.sampleRate,e.sampleRate),r=o.getChannelData(0);for(let e=0;e<r.length;e++)r[e]=2*Math.random()-1;let s=e.createBufferSource(),c=e.createGain();s.buffer=o,c.gain.setValueAtTime(.9,t),c.gain.exponentialRampToValueAtTime(.01,t+.3),s.connect(c),c.connect(e.destination),s.start()}function playShootSound(){let e=new AudioContext,t=e.currentTime,a=e.createOscillator(),n=e.createGain();a.type="sine",a.frequency.setValueAtTime(1500,t),a.frequency.exponentialRampToValueAtTime(200,t+.15),n.gain.setValueAtTime(.8,t),n.gain.exponentialRampToValueAtTime(.01,t+.15),a.connect(n),n.connect(e.destination),a.start(),a.stop(t+.15)}winScreen.addEventListener("click",restart),loseScreen.addEventListener("click",restart);const flashBtn=document.getElementById("flash-btn"),flashOverlay=document.getElementById("flash-overlay");function endTouch(e){e.preventDefault();for(let t=0;t<e.changedTouches.length;t++){let a=e.changedTouches[t];a.identifier===leftTouchId?(leftTouchId=null,leftStick.active=!1):a.identifier===rightTouchId&&(rightTouchId=null,rightStick.active=!1)}}flashBtn.addEventListener("click",()=>{!flashUsed&&gameActive&&(flashUsed=!0,flashBtn.disabled=!0,playFlashSound(),setTimeout(()=>{flashOverlay.style.display="flex",flashOverlay.style.background="#fff",flashOverlay.style.opacity="1",flashOverlay.className="",setTimeout(()=>{flashOverlay.classList.add("show-ad"),setTimeout(()=>{flashOverlay.classList.add("fade-out"),flashOverlay.addEventListener("transitionend",function e(){flashOverlay.removeEventListener("transitionend",e),flashOverlay.style.display="none",flashOverlay.className="",flashActive=!0,setTimeout(()=>{flashActive=!1},2e3)})},1e3)},500)},1500))}),startBtn.addEventListener("click",initAudio),window.addEventListener("keydown",e=>{["ArrowUp","ArrowDown","ArrowLeft","ArrowRight","w","a","s","d"].includes(e.key)&&e.preventDefault(),activeKeys.includes(e.key)||activeKeys.push(e.key)}),window.addEventListener("keyup",e=>{activeKeys=activeKeys.filter(t=>t!==e.key)}),window.addEventListener("mousemove",e=>{mousePos.x=e.clientX,mousePos.y=e.clientY}),canvas.addEventListener("touchstart",e=>{e.preventDefault();for(let t=0;t<e.changedTouches.length;t++){let a=e.changedTouches[t];a.clientX<window.innerWidth/2?null===leftTouchId&&(leftTouchId=a.identifier,leftStick.startX=a.clientX,leftStick.startY=a.clientY,leftStick.currX=a.clientX,leftStick.currY=a.clientY,leftStick.active=!0):null===rightTouchId&&(rightTouchId=a.identifier,rightStick.startX=a.clientX,rightStick.startY=a.clientY,rightStick.currX=a.clientX,rightStick.currY=a.clientY,rightStick.active=!0)}},{passive:!1}),canvas.addEventListener("touchmove",e=>{e.preventDefault();for(let t=0;t<e.changedTouches.length;t++){let a=e.changedTouches[t];a.identifier===leftTouchId?(leftStick.currX=a.clientX,leftStick.currY=a.clientY):a.identifier===rightTouchId&&(rightStick.currX=a.clientX,rightStick.currY=a.clientY)}},{passive:!1}),canvas.addEventListener("touchend",endTouch),canvas.addEventListener("touchcancel",endTouch),updateObjectiveUI();let MUS={playing:!1};function playSong(){if(MUS.playing)return;const e=MUS.AC||(MUS.AC=new(window.AudioContext||window.webkitAudioContext));if("suspended"===e.state&&e.resume(),MUS.playing=!0,MUS.bpm=132,MUS.step=0,MUS.bar=0,MUS.nextT=e.currentTime+.05,MUS.lookAhead=.12,!MUS.master){const t=e.createGain();t.gain.value=.85;const a=e.createDynamicsCompressor();a.threshold.value=-18,a.knee.value=25,a.ratio.value=10,a.attack.value=.003,a.release.value=.22;const n=e.createDelay(1),i=e.createDelay(1);n.delayTime.value=.11,i.delayTime.value=.145;const l=e.createGain(),o=e.createGain();l.gain.value=.35,o.gain.value=.33;const r=e.createStereoPanner();r.pan.value=-.35;const s=e.createStereoPanner();s.pan.value=.35,n.connect(l),l.connect(n),i.connect(o),o.connect(i);const c=e.createGain();c.gain.value=.22,n.connect(r),r.connect(c),i.connect(s),s.connect(c),t.connect(a),c.connect(a),a.connect(e.destination),MUS.master=t,MUS.wetSend={dL:n,dR:i}}MUS.timer=setInterval(()=>_songTick(),25)}function stopSong(){MUS.playing=!1,MUS.timer&&clearInterval(MUS.timer),MUS.timer=null}function _songTick(){const e=MUS.AC;if(!MUS.playing||!e)return;const t=60/MUS.bpm/4;for(;MUS.nextT<e.currentTime+MUS.lookAhead;){const e=MUS.step,a=[72,null,74,null,79,null,77,null,74,null,72,null,69,null,67,null],n=[72,null,74,76,79,null,77,76,74,null,72,null,69,67,69,null],i=[84,83,81,79,77,76,74,72,71,72,74,76,77,79,81,83],l=MUS.bar%16;let o=a;l>=4&&l<8?o=n:l>=8&&l<12?o=a:l>=12&&(o=i);const r=[36,null,36,null,34,null,34,null,31,null,31,null,33,null,33,null],s=[0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],c=[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1];[1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0][e]&&_kick(MUS.nextT),s[e]&&_snare(MUS.nextT),c[e]&&_hat(MUS.nextT),e%2==0&&_bass(MUS.nextT,r[e]??36),null!=o[e]&&_lead(MUS.nextT,o[e],l>=12?.1:.12),MUS.nextT+=t,MUS.step=MUS.step+1&15,0===MUS.step&&MUS.bar++}}function _mtof(e){return 440*Math.pow(2,(e-69)/12)}function _lead(e,t,a){const n=MUS.AC,i=_mtof(t),l=n.createOscillator(),o=n.createGain(),r=n.createBiquadFilter(),s=n.createStereoPanner();l.type="triangle",l.frequency.setValueAtTime(i,e),l.frequency.exponentialRampToValueAtTime(1.01*i,e+.03),r.type="lowpass",r.frequency.setValueAtTime(9e3,e),r.frequency.exponentialRampToValueAtTime(1800,e+a),s.pan.setValueAtTime(.35*Math.sin(MUS.bar%8/8*Math.PI*2),e),o.gain.setValueAtTime(1e-4,e),o.gain.exponentialRampToValueAtTime(.28,e+.006),o.gain.exponentialRampToValueAtTime(1e-4,e+a),l.connect(r),r.connect(s),s.connect(o),o.connect(MUS.master),o.connect(MUS.wetSend.dL),o.connect(MUS.wetSend.dR),l.start(e),l.stop(e+a+.02)}function _bass(e,t){const a=MUS.AC,n=_mtof(t),i=a.createOscillator(),l=a.createGain(),o=a.createBiquadFilter();i.type="sawtooth",i.frequency.setValueAtTime(n,e),i.frequency.exponentialRampToValueAtTime(.985*n,e+.12),o.type="lowpass",o.frequency.setValueAtTime(600,e),o.frequency.exponentialRampToValueAtTime(220,e+.18),l.gain.setValueAtTime(1e-4,e),l.gain.exponentialRampToValueAtTime(.35,e+.004),l.gain.exponentialRampToValueAtTime(1e-4,e+.18),i.connect(o),o.connect(l),l.connect(MUS.master),i.start(e),i.stop(e+.22)}function _kick(e){const t=MUS.AC,a=t.createOscillator(),n=t.createGain();a.type="sine",a.frequency.setValueAtTime(140,e),a.frequency.exponentialRampToValueAtTime(38,e+.1),n.gain.setValueAtTime(1e-4,e),n.gain.exponentialRampToValueAtTime(.95,e+.002),n.gain.exponentialRampToValueAtTime(1e-4,e+.18),a.connect(n),n.connect(MUS.master),a.start(e),a.stop(e+.2)}function _snare(e){const t=MUS.AC,a=t.sampleRate,n=.14*a|0,i=t.createBuffer(1,n,a),l=i.getChannelData(0);for(let e=0;e<n;e++)l[e]=(2*Math.random()-1)*(1-e/n);const o=t.createBufferSource();o.buffer=i;const r=t.createBiquadFilter();r.type="bandpass",r.frequency.value=1800,r.Q.value=1.2;const s=t.createGain();s.gain.setValueAtTime(1e-4,e),s.gain.exponentialRampToValueAtTime(.55,e+.003),s.gain.exponentialRampToValueAtTime(1e-4,e+.14),o.connect(r),r.connect(s),s.connect(MUS.master),o.start(e),o.stop(e+.16)}function _hat(e){const t=MUS.AC,a=t.sampleRate,n=.03*a|0,i=t.createBuffer(1,n,a),l=i.getChannelData(0);for(let e=0;e<n;e++)l[e]=2*Math.random()-1;const o=t.createBufferSource();o.buffer=i;const r=t.createBiquadFilter();r.type="highpass",r.frequency.value=6e3;const s=t.createGain();s.gain.setValueAtTime(1e-4,e),s.gain.exponentialRampToValueAtTime(.18,e+.001),s.gain.exponentialRampToValueAtTime(1e-4,e+.03),o.connect(r),r.connect(s),s.connect(MUS.master),o.start(e),o.stop(e+.04)}</script></body></html>